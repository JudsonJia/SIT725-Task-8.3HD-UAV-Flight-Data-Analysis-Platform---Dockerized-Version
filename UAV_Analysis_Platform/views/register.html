<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - UAV Analysis Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="blue-grey lighten-5">
<div class="container">
    <div class="row">
        <div class="col s12 m8 offset-m2">
            <div class="card" style="margin-top: 30px; border-radius: 8px;">
                <div class="card-content">
                        <span class="card-title center-align">
                            <i class="material-icons large teal-text" style="font-size: 3rem;">person_add</i>
                            <h4 style="margin-top: 0;">Create Account</h4>
                        </span>

                    <form id="register-form">
                        <div class="row">
                            <div class="input-field col s12 m6">
                                <i class="material-icons prefix">person</i>
                                <input id="firstName" type="text" class="validate" required>
                                <label for="firstName">First Name</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input id="lastName" type="text" class="validate" required>
                                <label for="lastName">Last Name</label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <i class="material-icons prefix">account_circle</i>
                                <input id="username" type="text" class="validate" required minlength="3">
                                <label for="username">Username</label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <i class="material-icons prefix">email</i>
                                <input id="email" type="email" class="validate" required>
                                <label for="email">Email</label>
                                <span class="helper-text" data-error="Please enter a valid email"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <i class="material-icons prefix">lock</i>
                                <input id="password" type="password" class="validate" required minlength="6">
                                <label for="password">Password</label>
                                <div class="password-strength" style="margin-top: 10px;">
                                    <div class="progress">
                                        <div id="password-strength-bar" class="determinate" style="width: 0%"></div>
                                    </div>
                                    <span id="password-strength-text" class="grey-text text-darken-1" style="font-size: 12px;">Password strength</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <i class="material-icons prefix">lock</i>
                                <input id="confirmPassword" type="password" class="validate" required>
                                <label for="confirmPassword">Confirm Password</label>
                                <span id="password-match-helper" class="helper-text"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12">
                                <button class="btn waves-effect waves-light teal btn-large" type="submit" style="width: 100%;">
                                    Register
                                    <i class="material-icons right">how_to_reg</i>
                                </button>
                            </div>
                        </div>
                    </form>

                    <div class="row">
                        <div class="col s12 center-align">
                            <p style="margin: 20px 0;">Already have an account? <a href="/login" class="teal-text">Login here</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="/js/auth.js"></script>
<script>
    $(document).ready(function() {
        const auth = new AuthManager();

        // Password strength checker
        function checkPasswordStrength(password) {
            let score = 0;
            let feedback = [];

            // Length check
            if (password.length >= 8) {
                score += 25;
            } else if (password.length >= 6) {
                score += 10;
                feedback.push("At least 8 characters recommended");
            } else {
                feedback.push("Too short");
            }

            // Lowercase letters
            if (/[a-z]/.test(password)) {
                score += 15;
            } else {
                feedback.push("Add lowercase letters");
            }

            // Uppercase letters
            if (/[A-Z]/.test(password)) {
                score += 15;
            } else {
                feedback.push("Add uppercase letters");
            }

            // Numbers
            if (/\d/.test(password)) {
                score += 15;
            } else {
                feedback.push("Add numbers");
            }

            // Special characters
            if (/[^A-Za-z0-9]/.test(password)) {
                score += 30;
            } else {
                feedback.push("Add special characters");
            }

            let strength = 'Very Weak';
            let color = '#f44336'; // Red

            if (score >= 80) {
                strength = 'Very Strong';
                color = '#4caf50'; // Green
            } else if (score >= 60) {
                strength = 'Strong';
                color = '#8bc34a'; // Light Green
            } else if (score >= 40) {
                strength = 'Medium';
                color = '#ff9800'; // Orange
            } else if (score >= 20) {
                strength = 'Weak';
                color = '#ff5722'; // Deep Orange
            }

            return { score, strength, color, feedback };
        }

        // Update password strength indicator
        $('#password').on('input', function() {
            const password = $(this).val();
            const strengthBar = $('#password-strength-bar');
            const strengthText = $('#password-strength-text');

            if (password.length === 0) {
                strengthBar.css('width', '0%');
                strengthText.text('Password strength').removeClass().addClass('grey-text text-darken-1');
                return;
            }

            const result = checkPasswordStrength(password);

            strengthBar.css({
                'width': result.score + '%',
                'background-color': result.color
            });

            strengthText.text(`${result.strength}${result.feedback.length > 0 ? ' - ' + result.feedback.slice(0, 2).join(', ') : ''}`)
                .removeClass()
                .css('color', result.color);
        });

        // Check password match
        $('#confirmPassword').on('input', function() {
            const password = $('#password').val();
            const confirmPassword = $(this).val();
            const helper = $('#password-match-helper');

            if (confirmPassword.length === 0) {
                helper.text('').removeClass();
                return;
            }

            if (password === confirmPassword) {
                helper.text('Passwords match').removeClass().addClass('helper-text green-text');
            } else {
                helper.text('Passwords do not match').removeClass().addClass('helper-text red-text');
            }
        });

        // Form submission
        $('#register-form').on('submit', async function(e) {
            e.preventDefault();

            const firstName = $('#firstName').val();
            const lastName = $('#lastName').val();
            const username = $('#username').val();
            const email = $('#email').val();
            const password = $('#password').val();
            const confirmPassword = $('#confirmPassword').val();

            if (password !== confirmPassword) {
                M.toast({ html: 'Passwords do not match', classes: 'red' });
                return;
            }

            // Check minimum password strength
            const strengthResult = checkPasswordStrength(password);
            if (strengthResult.score < 40) {
                M.toast({ html: 'Please choose a stronger password', classes: 'orange' });
                return;
            }

            try {
                await auth.register({
                    username,
                    email,
                    password,
                    profile: { firstName, lastName }
                });

                M.toast({ html: 'Registration successful! Please login.', classes: 'green' });

                // 注册成功后跳转到 login 页面
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1000);
            } catch (err) {
                M.toast({ html: err.message || 'Registration failed', classes: 'red' });
            }
        });

        // Initialize Materialize components
        M.AutoInit();
    });
</script>
</body>
</html>